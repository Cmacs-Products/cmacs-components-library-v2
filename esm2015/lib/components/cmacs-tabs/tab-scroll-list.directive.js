import { Directive, EventEmitter, Output } from '@angular/core';
import { fromEvent, Subscription } from 'rxjs';
import * as i0 from "@angular/core";
const MIN_SWIPE_DISTANCE = 0.1;
const STOP_SWIPE_DISTANCE = 0.01;
const REFRESH_INTERVAL = 20;
const SPEED_OFF_MULTIPLE = Math.pow(0.995, REFRESH_INTERVAL);
export class CmacsTabScrollListDirective {
    constructor(ngZone, elementRef) {
        this.ngZone = ngZone;
        this.elementRef = elementRef;
        this.lastWheelDirection = null;
        this.lastWheelTimestamp = 0;
        this.lastTimestamp = 0;
        this.lastTimeDiff = 0;
        this.lastMixedWheel = 0;
        this.lastWheelPrevent = false;
        this.touchPosition = null;
        this.lastOffset = null;
        this.motion = -1;
        this.unsubscribe = () => void 0;
        this.offsetChange = new EventEmitter();
        this.tabScroll = new EventEmitter();
        this.onTouchEnd = (e) => {
            if (!this.touchPosition) {
                return;
            }
            const lastOffset = this.lastOffset;
            const lastTimeDiff = this.lastTimeDiff;
            this.lastOffset = this.touchPosition = null;
            if (lastOffset) {
                const distanceX = lastOffset.x / lastTimeDiff;
                const distanceY = lastOffset.y / lastTimeDiff;
                const absX = Math.abs(distanceX);
                const absY = Math.abs(distanceY);
                // Skip swipe if low distance
                if (Math.max(absX, absY) < MIN_SWIPE_DISTANCE) {
                    return;
                }
                let currentX = distanceX;
                let currentY = distanceY;
                this.motion = window.setInterval(() => {
                    if (Math.abs(currentX) < STOP_SWIPE_DISTANCE && Math.abs(currentY) < STOP_SWIPE_DISTANCE) {
                        window.clearInterval(this.motion);
                        return;
                    }
                    currentX *= SPEED_OFF_MULTIPLE;
                    currentY *= SPEED_OFF_MULTIPLE;
                    this.onOffset(currentX * REFRESH_INTERVAL, currentY * REFRESH_INTERVAL, e);
                }, REFRESH_INTERVAL);
            }
        };
        this.onTouchMove = (e) => {
            if (!this.touchPosition) {
                return;
            }
            e.preventDefault();
            const { screenX, screenY } = e.touches[0];
            const offsetX = screenX - this.touchPosition.x;
            const offsetY = screenY - this.touchPosition.y;
            this.onOffset(offsetX, offsetY, e);
            const now = Date.now();
            this.lastTimeDiff = now - this.lastTimestamp;
            this.lastTimestamp = now;
            this.lastOffset = { x: offsetX, y: offsetY };
            this.touchPosition = { x: screenX, y: screenY };
        };
        this.onTouchStart = (e) => {
            const { screenX, screenY } = e.touches[0];
            this.touchPosition = { x: screenX, y: screenY };
            window.clearInterval(this.motion);
        };
        this.onWheel = (e) => {
            const { deltaX, deltaY } = e;
            let mixed;
            const absX = Math.abs(deltaX);
            const absY = Math.abs(deltaY);
            if (absX === absY) {
                mixed = this.lastWheelDirection === 'x' ? deltaX : deltaY;
            }
            else if (absX > absY) {
                mixed = deltaX;
                this.lastWheelDirection = 'x';
            }
            else {
                mixed = deltaY;
                this.lastWheelDirection = 'y';
            }
            // Optimize mac touch scroll
            const now = Date.now();
            const absMixed = Math.abs(mixed);
            if (now - this.lastWheelTimestamp > 100 || absMixed - this.lastMixedWheel > 10) {
                this.lastWheelPrevent = false;
            }
            this.onOffset(-mixed, -mixed, e);
            if (e.defaultPrevented || this.lastWheelPrevent) {
                this.lastWheelPrevent = true;
            }
            this.lastWheelTimestamp = now;
            this.lastMixedWheel = absMixed;
        };
    }
    ngOnInit() {
        this.unsubscribe = this.ngZone.runOutsideAngular(() => {
            const el = this.elementRef.nativeElement;
            const wheel$ = fromEvent(el, 'wheel');
            const touchstart$ = fromEvent(el, 'touchstart');
            const touchmove$ = fromEvent(el, 'touchmove');
            const touchend$ = fromEvent(el, 'touchend');
            const subscription = new Subscription();
            subscription.add(this.subscribeWrap('wheel', wheel$, this.onWheel));
            subscription.add(this.subscribeWrap('touchstart', touchstart$, this.onTouchStart));
            subscription.add(this.subscribeWrap('touchmove', touchmove$, this.onTouchMove));
            subscription.add(this.subscribeWrap('touchend', touchend$, this.onTouchEnd));
            return () => {
                subscription.unsubscribe();
            };
        });
    }
    subscribeWrap(type, observable, handler) {
        return observable.subscribe(event => {
            this.tabScroll.emit({
                type,
                event
            });
            if (!event.defaultPrevented) {
                handler(event);
            }
        });
    }
    onOffset(x, y, event) {
        this.ngZone.run(() => {
            this.offsetChange.emit({
                x,
                y,
                event
            });
        });
    }
    ngOnDestroy() {
        this.unsubscribe();
    }
}
CmacsTabScrollListDirective.ɵfac = function CmacsTabScrollListDirective_Factory(t) { return new (t || CmacsTabScrollListDirective)(i0.ɵɵdirectiveInject(i0.NgZone), i0.ɵɵdirectiveInject(i0.ElementRef)); };
CmacsTabScrollListDirective.ɵdir = i0.ɵɵdefineDirective({ type: CmacsTabScrollListDirective, selectors: [["", "cmacsTabScrollList", ""]], outputs: { offsetChange: "offsetChange", tabScroll: "tabScroll" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(CmacsTabScrollListDirective, [{
        type: Directive,
        args: [{
                selector: '[cmacsTabScrollList]'
            }]
    }], function () { return [{ type: i0.NgZone }, { type: i0.ElementRef }]; }, { offsetChange: [{
            type: Output
        }], tabScroll: [{
            type: Output
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFiLXNjcm9sbC1saXN0LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NtYWNzLWNvbXBvbmVudHMtdjItbGliL3NyYy9saWIvY29tcG9uZW50cy9jbWFjcy10YWJzL3RhYi1zY3JvbGwtbGlzdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQTZCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV2RyxPQUFPLEVBQUUsU0FBUyxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFJM0QsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLENBQUM7QUFDL0IsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUM7QUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDNUIsTUFBTSxrQkFBa0IsR0FBRyxTQUFBLEtBQUssRUFBSSxnQkFBZ0IsQ0FBQSxDQUFDO0FBS3JELE1BQU0sT0FBTywyQkFBMkI7SUFnQnRDLFlBQW9CLE1BQWMsRUFBVSxVQUFtQztRQUEzRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBeUI7UUFmL0UsdUJBQWtCLEdBQXFCLElBQUksQ0FBQztRQUM1Qyx1QkFBa0IsR0FBRyxDQUFDLENBQUM7UUFDdkIsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFDbEIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFDakIsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkIscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLGtCQUFhLEdBQWlDLElBQUksQ0FBQztRQUNuRCxlQUFVLEdBQWlDLElBQUksQ0FBQztRQUNoRCxXQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFWixnQkFBVyxHQUFlLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXBCLGlCQUFZLEdBQUcs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QUM7O3NHQWhLVSwyQkFBMkI7Z0VBQTNCLDJCQUEyQjt1RkFBM0IsMkJBQTJCO2NBSHZDLFNBQVM7ZUFBQztnQkFDVCxRQUFRLEVBQUUsc0JBQXNCO2FBQ2pDO2tGQWNvQixZQUFZO2tCQUE5QixNQUFNO1lBQ1ksU0FBUztrQkFBM0IsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IGZyb21FdmVudCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBOelRhYlNjcm9sbEV2ZW50LCBOelRhYlNjcm9sbEV2ZW50SGFuZGxlckZ1biwgTnpUYWJTY3JvbGxMaXN0T2Zmc2V0LCBOelRhYlNjcm9sbExpc3RPZmZzZXRFdmVudCB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XHJcblxyXG5jb25zdCBNSU5fU1dJUEVfRElTVEFOQ0UgPSAwLjE7XHJcbmNvbnN0IFNUT1BfU1dJUEVfRElTVEFOQ0UgPSAwLjAxO1xyXG5jb25zdCBSRUZSRVNIX0lOVEVSVkFMID0gMjA7XHJcbmNvbnN0IFNQRUVEX09GRl9NVUxUSVBMRSA9IDAuOTk1ICoqIFJFRlJFU0hfSU5URVJWQUw7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tjbWFjc1RhYlNjcm9sbExpc3RdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgQ21hY3NUYWJTY3JvbGxMaXN0RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gIGxhc3RXaGVlbERpcmVjdGlvbjogJ3gnIHwgJ3knIHwgbnVsbCA9IG51bGw7XHJcbiAgbGFzdFdoZWVsVGltZXN0YW1wID0gMDtcclxuICBsYXN0VGltZXN0YW1wID0gMDtcclxuICBsYXN0VGltZURpZmYgPSAwO1xyXG4gIGxhc3RNaXhlZFdoZWVsID0gMDtcclxuICBsYXN0V2hlZWxQcmV2ZW50ID0gZmFsc2U7XHJcbiAgdG91Y2hQb3NpdGlvbjogTnpUYWJTY3JvbGxMaXN0T2Zmc2V0IHwgbnVsbCA9IG51bGw7XHJcbiAgbGFzdE9mZnNldDogTnpUYWJTY3JvbGxMaXN0T2Zmc2V0IHwgbnVsbCA9IG51bGw7XHJcbiAgbW90aW9uID0gLTE7XHJcblxyXG4gIHVuc3Vic2NyaWJlOiAoKSA9PiB2b2lkID0gKCkgPT4gdm9pZCAwO1xyXG5cclxuICBAT3V0cHV0KCkgcmVhZG9ubHkgb2Zmc2V0Q2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxOelRhYlNjcm9sbExpc3RPZmZzZXRFdmVudD4oKTtcclxuICBAT3V0cHV0KCkgcmVhZG9ubHkgdGFiU2Nyb2xsID0gbmV3IEV2ZW50RW1pdHRlcjxOelRhYlNjcm9sbEV2ZW50PigpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+KSB7fVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMudW5zdWJzY3JpYmUgPSB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGVsID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgICBjb25zdCB3aGVlbCQgPSBmcm9tRXZlbnQ8V2hlZWxFdmVudD4oZWwsICd3aGVlbCcpO1xyXG4gICAgICBjb25zdCB0b3VjaHN0YXJ0JCA9IGZyb21FdmVudDxUb3VjaEV2ZW50PihlbCwgJ3RvdWNoc3RhcnQnKTtcclxuICAgICAgY29uc3QgdG91Y2htb3ZlJCA9IGZyb21FdmVudDxUb3VjaEV2ZW50PihlbCwgJ3RvdWNobW92ZScpO1xyXG4gICAgICBjb25zdCB0b3VjaGVuZCQgPSBmcm9tRXZlbnQ8VG91Y2hFdmVudD4oZWwsICd0b3VjaGVuZCcpO1xyXG5cclxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgnd2hlZWwnLCB3aGVlbCQsIHRoaXMub25XaGVlbCkpO1xyXG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgndG91Y2hzdGFydCcsIHRvdWNoc3RhcnQkLCB0aGlzLm9uVG91Y2hTdGFydCkpO1xyXG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgndG91Y2htb3ZlJywgdG91Y2htb3ZlJCwgdGhpcy5vblRvdWNoTW92ZSkpO1xyXG4gICAgICBzdWJzY3JpcHRpb24uYWRkKHRoaXMuc3Vic2NyaWJlV3JhcCgndG91Y2hlbmQnLCB0b3VjaGVuZCQsIHRoaXMub25Ub3VjaEVuZCkpO1xyXG5cclxuICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgfTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3Vic2NyaWJlV3JhcDxUIGV4dGVuZHMgTnpUYWJTY3JvbGxFdmVudFsnZXZlbnQnXT4oXHJcbiAgICB0eXBlOiBOelRhYlNjcm9sbEV2ZW50Wyd0eXBlJ10sXHJcbiAgICBvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPFQ+LFxyXG4gICAgaGFuZGxlcjogTnpUYWJTY3JvbGxFdmVudEhhbmRsZXJGdW48VD5cclxuICApOiBTdWJzY3JpcHRpb24ge1xyXG4gICAgcmV0dXJuIG9ic2VydmFibGUuc3Vic2NyaWJlKGV2ZW50ID0+IHtcclxuICAgICAgdGhpcy50YWJTY3JvbGwuZW1pdCh7XHJcbiAgICAgICAgdHlwZSxcclxuICAgICAgICBldmVudFxyXG4gICAgICB9IGFzIE56VGFiU2Nyb2xsRXZlbnQpO1xyXG4gICAgICBpZiAoIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcclxuICAgICAgICBoYW5kbGVyKGV2ZW50KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBvblRvdWNoRW5kID0gKGU6IFRvdWNoRXZlbnQpOiB2b2lkID0+IHtcclxuICAgIGlmICghdGhpcy50b3VjaFBvc2l0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGxhc3RPZmZzZXQgPSB0aGlzLmxhc3RPZmZzZXQ7XHJcbiAgICBjb25zdCBsYXN0VGltZURpZmYgPSB0aGlzLmxhc3RUaW1lRGlmZjtcclxuXHJcbiAgICB0aGlzLmxhc3RPZmZzZXQgPSB0aGlzLnRvdWNoUG9zaXRpb24gPSBudWxsO1xyXG5cclxuICAgIGlmIChsYXN0T2Zmc2V0KSB7XHJcbiAgICAgIGNvbnN0IGRpc3RhbmNlWCA9IGxhc3RPZmZzZXQueCAvIGxhc3RUaW1lRGlmZjtcclxuICAgICAgY29uc3QgZGlzdGFuY2VZID0gbGFzdE9mZnNldC55IC8gbGFzdFRpbWVEaWZmO1xyXG4gICAgICBjb25zdCBhYnNYID0gTWF0aC5hYnMoZGlzdGFuY2VYKTtcclxuICAgICAgY29uc3QgYWJzWSA9IE1hdGguYWJzKGRpc3RhbmNlWSk7XHJcblxyXG4gICAgICAvLyBTa2lwIHN3aXBlIGlmIGxvdyBkaXN0YW5jZVxyXG4gICAgICBpZiAoTWF0aC5tYXgoYWJzWCwgYWJzWSkgPCBNSU5fU1dJUEVfRElTVEFOQ0UpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBjdXJyZW50WCA9IGRpc3RhbmNlWDtcclxuICAgICAgbGV0IGN1cnJlbnRZID0gZGlzdGFuY2VZO1xyXG5cclxuICAgICAgdGhpcy5tb3Rpb24gPSB3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgIGlmIChNYXRoLmFicyhjdXJyZW50WCkgPCBTVE9QX1NXSVBFX0RJU1RBTkNFICYmIE1hdGguYWJzKGN1cnJlbnRZKSA8IFNUT1BfU1dJUEVfRElTVEFOQ0UpIHtcclxuICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRoaXMubW90aW9uKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGN1cnJlbnRYICo9IFNQRUVEX09GRl9NVUxUSVBMRTtcclxuICAgICAgICBjdXJyZW50WSAqPSBTUEVFRF9PRkZfTVVMVElQTEU7XHJcbiAgICAgICAgdGhpcy5vbk9mZnNldChjdXJyZW50WCAqIFJFRlJFU0hfSU5URVJWQUwsIGN1cnJlbnRZICogUkVGUkVTSF9JTlRFUlZBTCwgZSk7XHJcbiAgICAgIH0sIFJFRlJFU0hfSU5URVJWQUwpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIG9uVG91Y2hNb3ZlID0gKGU6IFRvdWNoRXZlbnQpOiB2b2lkID0+IHtcclxuICAgIGlmICghdGhpcy50b3VjaFBvc2l0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBjb25zdCB7IHNjcmVlblgsIHNjcmVlblkgfSA9IGUudG91Y2hlc1swXTtcclxuXHJcbiAgICBjb25zdCBvZmZzZXRYID0gc2NyZWVuWCAtIHRoaXMudG91Y2hQb3NpdGlvbi54O1xyXG4gICAgY29uc3Qgb2Zmc2V0WSA9IHNjcmVlblkgLSB0aGlzLnRvdWNoUG9zaXRpb24ueTtcclxuICAgIHRoaXMub25PZmZzZXQob2Zmc2V0WCwgb2Zmc2V0WSwgZSk7XHJcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xyXG5cclxuICAgIHRoaXMubGFzdFRpbWVEaWZmID0gbm93IC0gdGhpcy5sYXN0VGltZXN0YW1wO1xyXG4gICAgdGhpcy5sYXN0VGltZXN0YW1wID0gbm93O1xyXG4gICAgdGhpcy5sYXN0T2Zmc2V0ID0geyB4OiBvZmZzZXRYLCB5OiBvZmZzZXRZIH07XHJcbiAgICB0aGlzLnRvdWNoUG9zaXRpb24gPSB7IHg6IHNjcmVlblgsIHk6IHNjcmVlblkgfTtcclxuICB9O1xyXG5cclxuICBvblRvdWNoU3RhcnQgPSAoZTogVG91Y2hFdmVudCk6IHZvaWQgPT4ge1xyXG4gICAgY29uc3QgeyBzY3JlZW5YLCBzY3JlZW5ZIH0gPSBlLnRvdWNoZXNbMF07XHJcbiAgICB0aGlzLnRvdWNoUG9zaXRpb24gPSB7IHg6IHNjcmVlblgsIHk6IHNjcmVlblkgfTtcclxuICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRoaXMubW90aW9uKTtcclxuICB9O1xyXG5cclxuICBvbldoZWVsID0gKGU6IFdoZWVsRXZlbnQpOiB2b2lkID0+IHtcclxuICAgIGNvbnN0IHsgZGVsdGFYLCBkZWx0YVkgfSA9IGU7XHJcbiAgICBsZXQgbWl4ZWQ6IG51bWJlcjtcclxuICAgIGNvbnN0IGFic1ggPSBNYXRoLmFicyhkZWx0YVgpO1xyXG4gICAgY29uc3QgYWJzWSA9IE1hdGguYWJzKGRlbHRhWSk7XHJcblxyXG4gICAgaWYgKGFic1ggPT09IGFic1kpIHtcclxuICAgICAgbWl4ZWQgPSB0aGlzLmxhc3RXaGVlbERpcmVjdGlvbiA9PT0gJ3gnID8gZGVsdGFYIDogZGVsdGFZO1xyXG4gICAgfSBlbHNlIGlmIChhYnNYID4gYWJzWSkge1xyXG4gICAgICBtaXhlZCA9IGRlbHRhWDtcclxuICAgICAgdGhpcy5sYXN0V2hlZWxEaXJlY3Rpb24gPSAneCc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBtaXhlZCA9IGRlbHRhWTtcclxuICAgICAgdGhpcy5sYXN0V2hlZWxEaXJlY3Rpb24gPSAneSc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gT3B0aW1pemUgbWFjIHRvdWNoIHNjcm9sbFxyXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgIGNvbnN0IGFic01peGVkID0gTWF0aC5hYnMobWl4ZWQpO1xyXG5cclxuICAgIGlmIChub3cgLSB0aGlzLmxhc3RXaGVlbFRpbWVzdGFtcCA+IDEwMCB8fCBhYnNNaXhlZCAtIHRoaXMubGFzdE1peGVkV2hlZWwgPiAxMCkge1xyXG4gICAgICB0aGlzLmxhc3RXaGVlbFByZXZlbnQgPSBmYWxzZTtcclxuICAgIH1cclxuICAgIHRoaXMub25PZmZzZXQoLW1peGVkLCAtbWl4ZWQsIGUpO1xyXG4gICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZCB8fCB0aGlzLmxhc3RXaGVlbFByZXZlbnQpIHtcclxuICAgICAgdGhpcy5sYXN0V2hlZWxQcmV2ZW50ID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmxhc3RXaGVlbFRpbWVzdGFtcCA9IG5vdztcclxuICAgIHRoaXMubGFzdE1peGVkV2hlZWwgPSBhYnNNaXhlZDtcclxuICB9O1xyXG5cclxuICBvbk9mZnNldCh4OiBudW1iZXIsIHk6IG51bWJlciwgZXZlbnQ6IEV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICB0aGlzLm9mZnNldENoYW5nZS5lbWl0KHtcclxuICAgICAgICB4LFxyXG4gICAgICAgIHksXHJcbiAgICAgICAgZXZlbnRcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy51bnN1YnNjcmliZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=